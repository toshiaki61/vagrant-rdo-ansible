---
- yum: name={{ item }} state=installed
  with_items:
    - memcached
    - python-memcached
    - mod_wsgi
    - openstack-dashboard
  tags: dashboard

- shell: "sed -i \"s/'BACKEND' : 'django.core.cache.backends.locmem.LocMemCache'/'BACKEND' : 'django.core.cache.backends.memcached.MemcachedCache','LOCATION' : '127.0.0.1:11211'/g\" /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-1 creates=~/.executed-dashboard-1"
  tags: dashboard
- shell: sed -i 's,^TIME_ZONE = "UTC",TIME_ZONE = "Asia/Tokyo",g' /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-3 creates=~/.executed-dashboard-3
  tags: dashboard
- shell: sed -i "s/^ALLOWED_HOSTS =.*/ALLOWED_HOSTS = ['*']/g" /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-4 creates=~/.executed-dashboard-4
  tags: dashboard
- shell: sed -i 's/^OPENSTACK_HOST =.*/OPENSTACK_HOST = "controller"/g' /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-5 creates=~/.executed-dashboard-5
  tags: dashboard
# - shell: setsebool -P httpd_can_network_connect on && touch ~/.executed-dashboard-6 creates=~/.executed-dashboard-6
#   tags: dashboard
- shell: echo "ServerName controller" | sudo tee /etc/httpd/conf.d/domain.conf  && touch ~/.executed-dashboard-6.1 creates=~/.executed-dashboard-6.1
  tags: dashboard

- service: name={{ item }} state=running enabled=yes
  with_items:
    - httpd
    - memcached
  tags: dashboard

- shell: cat /vagrant/provisioning/roles/controller/files/local_settings | sudo tee -a /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-2.1 creates=~/.executed-dashboard-2.1
  tags: dashboard
- shell: "echo \"DATABASES = {'default': {'ENGINE': 'django.db.backends.mysql','NAME': 'dash','USER': 'dash','PASSWORD': '{{ DASH_DBPASS }}','HOST': 'localhost', 'default-character-set': 'utf8'}}\" | sudo tee -a /etc/openstack-dashboard/local_settings && touch ~/.executed-dashboard-7 creates=~/.executed-dashboard-7"
  tags: dashboard

- shell: /usr/share/openstack-dashboard/manage.py syncdb --noinput && touch ~/.executed-dashboard-8 creates=~/.executed-dashboard-8
  tags: dashboard

- shell: chown apache:apache /tmp/.secret_key_store && touch ~/.executed-dashboard-9 creates=~/.executed-dashboard-9
  tags: dashboard

- stat: path=/vagrant/tmp/horizon
  register: check_path
  tags: dashboard

- git: repo=git://github.com/openstack/horizon.git
       dest=/vagrant/tmp/horizon
       version=stable/icehouse
  # when: check_path.stat.exists == false
  tags: dashboard

- shell: cp -R /vagrant/tmp/horizon/openstack_dashboard/locale/ja/LC_MESSAGES /usr/share/openstack-dashboard/openstack_dashboard/locale/ja/ && touch ~/.executed-dashboard-10 creates=~/.executed-dashboard-10
  tags: dashboard

- service: name={{ item }} state=restarted
  with_items:
    - httpd
    - openstack-nova-api
  tags: dashboard
